name: Docker build (builder) → Publish static to gh-pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  DOCKERFILE_PATH: ./Dockerfile
  BUILD_CONTEXT: .
  BUILD_TARGET: builder
  IMAGE_NAME: sentiment-analyzer-build
  CONTAINER_TMP_NAME: sa_build_tmp
  DIST_PATH_IN_IMAGE: /workspace/apps/web/dist
  OUT_DIR_REL: out
  OUT_DIR: ${{ github.workspace }}/out
  PUBLISH_BRANCH: gh-pages

jobs:
  docker-build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show configuration
        run: |
          echo "DOCKERFILE_PATH=${{ env.DOCKERFILE_PATH }}"
          echo "BUILD_TARGET=${{ env.BUILD_TARGET }}"
          echo "DIST_PATH_IN_IMAGE=${{ env.DIST_PATH_IN_IMAGE }}"
          echo "OUT_DIR=${{ env.OUT_DIR }}"

      - name: Build Docker image (builder stage)
        run: |
          docker build \
            --progress=plain \
            -t "${IMAGE_NAME}:${GITHUB_SHA}" \
            -f "${DOCKERFILE_PATH}" \
            --target "${BUILD_TARGET}" \
            "${BUILD_CONTEXT}"

      - name: Create temporary container from built image
        id: create_container
        run: |
          docker rm -f "${CONTAINER_TMP_NAME}" 2>/dev/null || true
          CID=$(docker create --name "${CONTAINER_TMP_NAME}" "${IMAGE_NAME}:${GITHUB_SHA}")
          echo "container_id=$CID" >> $GITHUB_OUTPUT

      - name: Copy build output from container to workspace
        run: |
          rm -rf "${{ env.OUT_DIR }}" || true
          mkdir -p "${{ env.OUT_DIR }}"
          echo "Tentando copiar: ${CONTAINER_TMP_NAME}:${DIST_PATH_IN_IMAGE} -> ${OUT_DIR}"
          # copia todo o conteúdo do dist do container para OUT_DIR
          if docker cp "${CONTAINER_TMP_NAME}:${DIST_PATH_IN_IMAGE}/." "${{ env.OUT_DIR }}/"; then
            echo "Conteúdo copiado para ${{ env.OUT_DIR }}"
          else
            echo "Falha ao copiar ${DIST_PATH_IN_IMAGE} do container — debug em container:"
            docker container ls -a
            echo "Listando /workspace dentro do container:"
            docker exec "${CONTAINER_TMP_NAME}" sh -c "ls -la /workspace || true"
            echo "Listando /workspace/apps dentro do container:"
            docker exec "${CONTAINER_TMP_NAME}" sh -c "ls -la /workspace/apps || true"
            echo "Tentando listar DIST_PATH_IN_IMAGE:"
            docker exec "${CONTAINER_TMP_NAME}" sh -c "ls -la ${DIST_PATH_IN_IMAGE} || true"
            docker rm -f "${CONTAINER_TMP_NAME}" || true
            exit 1
          fi
          echo "Conteúdo final em ${{ env.OUT_DIR }}:"
          ls -la "${{ env.OUT_DIR }}"

      - name: Remove temporary container
        if: always()
        run: docker rm -f "${CONTAINER_TMP_NAME}" || true

      - name: Confirm publish dir
        run: |
          echo "Conteúdo final a ser publicado (root = ${{ env.OUT_DIR }}):"
          ls -la "${{ env.OUT_DIR }}" || (echo "Diretório ${OUT_DIR} vazio" && exit 1)

      - name: Deploy to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: "${{ env.OUT_DIR }}"
          publish_branch: ${{ env.PUBLISH_BRANCH }}
          keep_files: false
